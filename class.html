<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="generator" content="AsciiDoc 8.6.9, html5 backend 4.5.0">
    <title>C Language Style for Scalability</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Pieter Hintjens">
    <!-- AsciiDoc Bootstrap styles -->
    <link rel="stylesheet" type="text/css" id="bootstrapTheme" href="css/asciidoc-bootstrap.min.css">

    <!--[if (lt IE 9) & (!IEMobile)]>
        <script src="js/html5shiv.min.js"></script>
        <script src="js/respond.min.js"></script>
    <![endif]-->
    <!-- 42ITy stylesheet -->
    <link rel="stylesheet" type="text/css" href="css/42ity.css">

    <!-- favorite icon -->
    <link rel="shortcut icon" href="images/icons//favicon.ico">
  </head>
  <body id="toc-top">
    <div id="page">
  <header role="banner" class="Fixed">

    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">

    <div class="container">

        <div class="navbar-header">
          <a class="navbar-brand" href="./">42ITy</a>
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div> <!-- /.navbar-header -->

        <div class="navbar-collapse collapse">
            <!-- Fixed navbar -->
            <ul class="nav navbar-nav">
                <li><a href="index.html">Home</a></li>
            </ul>
            <ul class="nav navbar-nav">
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Download<span class="caret"></span></a>
                    <ul class="dropdown-menu">
                        <li><a href="source.html">Source code</a></li>
                        <li><a href="binaries.html">Binaries</a></li>
                    </ul>
                </li>
            </ul>
            <ul class="nav navbar-nav">
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Documentation<span class="caret"></span></a>
                    <ul class="dropdown-menu">
                        <li><a href="hcl.html">Supported Hardware</a></li>
                        <li role="separator" class="divider"></li>
                        <li><a href="presentation.html">Overall presentation</a></li>
                        <li><a href="contributing.html">Contributor guide</a></li>
                    </ul>
                </li>
            </ul>
            <ul class="nav navbar-nav">
                <li><a href="about.html">About</a></li>
            </ul>
            <ul class="nav navbar-nav">
                <li><a href="contact.html">Contact</a></li>
            </ul>
        </div> <!-- /.navbar-collapse -->

    </div>  <!-- /.container -->
    </nav>
  </header>


  <div id="content" class="container">

    <div class="row">




        <div class="col-md-9" role="main">
<div class="section">
    <h1 class="page-header" id="c_language_style_for_scalability">C Language Style for Scalability</h1>
<div class="paragraph"><p>The C Language Style for Scalability (CLASS) defines a consistent style
and organization for scalable C library and application code built on
modern C compilers and operating systems. CLASS aims to collect industry
best practice into one reusable standard.</p></div>
<div class="paragraph"><p>CLASS was created by Pieter Hintjens, originally for the ZeroMQ project,
and is available as a ZeroMQ RFC
(
<a href="https://rfc.zeromq.org/spec:21/CLASS/">CLASS (C Language Style for Scalability)</a> ).</p></div>
<div class="paragraph"><p>This version of CLASS amends the original linked above in a few points:</p></div>
<div class="ulist"><ul>
<li>
<p>
clarification of ZeroMQ vs. IETF "RFC"s;
</p>
</li>
<li>
<p>
added Unix shared libraries, pkg-config declarations, and service
management definitions for daemons to the list of things that a project
SHOULD deliver;
</p>
</li>
<li>
<p>
revised "verbatim" markup in-lined in the text, and fixed a few typos;
</p>
</li>
<li>
<p>
requirement by default of <code>asciidoc</code> compatible markup for text files
and source comments, unless a different markup is not easily avoidable
(this and other aspects of documentation style, format and tooling were
since relocated into a separate document:

<a href="doc-recommendation.html">Documentation Recommendation</a>);
</p>
</li>
<li>
<p>
added standard text-processing programs among "dependencies" for the
projects which aim to deliver rendered end-user documentation formats;
</p>
</li>
<li>
<p>
the template README file markup made compatible with <code>asciidoc</code>.
</p>
</li>
</ul></div>
<h2 id="license">License</h2>
<div class="paragraph"><p>Copyright (c) 2009-2013 iMatix Corporation</p></div>
<div class="paragraph"><p>This Specification is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License as published
by the Free Software Foundation; either version 3 of the License, or (at
your option) any later version.</p></div>
<div class="paragraph"><p>This Specification is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General
Public License for more details.</p></div>
<div class="paragraph"><p>You should have received a copy of the GNU General Public License along
with this program; if not, see <a href="http://www.gnu.org/licenses">http://www.gnu.org/licenses</a>.</p></div>
<h2 id="change-process">Change Process</h2>
<div class="paragraph"><p>This Specification is a free and open standard (see
"<a href="http://www.digistan.org/open-standard:definition">Definition of a Free
and Open Standard</a>") and is governed by the Digital Standards
Organization&#8217;s Consensus-Oriented Specification System (COSS) (see
"<a href="http://www.digistan.org/spec:1/COSS">Consensus Oriented Specification
System</a>").</p></div>
<h2 id="language">Language</h2>
<div class="paragraph"><p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
"SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
document are to be interpreted as described in IETF RFC 2119 (see
"<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to
Indicate Requirement Levels</a>").</p></div>
<h2 id="goals">Goals</h2>
<div class="paragraph"><p>CLASS aims to be a complete and reusable style and organization guide
for scalable C projects. CLASS collects best practice to solve a set of
specific and well-known quality problems with C projects. It evolved
from the style guide of the ZeroMQ <a href="https://github.com/zeromq/czmq">CZMQ
project</a>. CLASS is plug compatible with the "coding style guide"
requirements of the C4 process (see
"<a href="http://rfc.zeromq.org/spec:16">Collective Code Construction Contract</a>")
and its revisions.</p></div>
<div class="paragraph"><p>The specific goals for this Specification are to:</p></div>
<div class="ulist"><ul>
<li>
<p>
Give project maintainers and contributors a tool for measuring the
quality of patches to a project.
</p>
</li>
<li>
<p>
Give the code the appearance of a single perfect author writing at one
moment in time.
</p>
</li>
<li>
<p>
Reduce the number of lines of code and complexity of C projects.
</p>
</li>
<li>
<p>
Ensure total consistency of every line of code, across a large number
of projects.
</p>
</li>
<li>
<p>
Reduce the risk of writing C code by solving common C style problems
in a minimal fashion.
</p>
</li>
<li>
<p>
Provide a vehicle to collect best practice over time.
</p>
</li>
</ul></div>
<h3 id="quality-aspirations">Quality Aspirations</h3>
<div class="paragraph"><p>The goal of CLASS is to help programmers write high-quality C code in a
consistent fashion. We define "high quality" primarily thus:</p></div>
<div class="ulist"><ul>
<li>
<p>
The code is easy to read and understand even if you know little or
nothing about its specific context.
</p>
</li>
<li>
<p>
The code is easy to reuse and remix, in whole or in fragments.
</p>
</li>
<li>
<p>
The code is easy to write correctly, and errors are rapidly clear.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Our main tool for achieving this is to identify and apply the best
patterns and styles. The reader can learn these once, and then see them
repeatedly across a wide body of code. Deviations from familiar patterns
can then be taken as a sign of low-quality code that is more likely to
contain errors and less remixable.</p></div>
<h3 id="common-problems">Common Problems</h3>
<div class="paragraph"><p>With this Specification we aim to address a specific set of problems
that hurt the quality, remixability, and economics of many C projects:</p></div>
<div class="ulist"><ul>
<li>
<p>
If there is no style guide for a project, the maintainers must either
rewrite contributions by hand (which costs extra work), or must abandon
any attempt to enforce a consistent "voice" across a project (which
hurts code quality and reusability). Thus maintainers need a written
style guide to which they can point contributors.
</p>
</li>
<li>
<p>
If there is no reusable style guide, each project founder will
improvise their own ad hoc style. This wastes previous experience, and
creates unnecessary work for project founders. It also means each
project will end up with a different style.
</p>
</li>
<li>
<p>
If a set of projects each have a different style, they cannot share
code easily, which damages the economics of remixing. The more projects
that use a single style, the lower the cost of code reuse. This is
especially important in open source but also applies to projects built
internally in an organization.
</p>
</li>
<li>
<p>
With no vehicle for collecting and sharing best practices in C
programming, most projects will have mediocre structuring and style,
leading to unnecessary complexity, excess lines of code, accumulation of
unused code, and other quality problems.
</p>
</li>
<li>
<p>
When project founders create a new project without help, they often
make mistakes such as forgetting to define a license for their code.
This can create legal problems.
</p>
</li>
</ul></div>
<div class="paragraph"><p>While these problems can affect all software projects, we solve them
specifically for C projects.</p></div>
<h2 id="general-style">General Style</h2>
<h3 id="definitions">Definitions</h3>
<div class="paragraph"><p>The overall unit of work is a <em>project</em> that builds as a library with a
set of executable test programs and supplemental command-line tools.</p></div>
<div class="paragraph"><p>The project is composed of <em>classes</em>, where each class covers one area
of work and is implemented as a source file with matching header file.</p></div>
<div class="paragraph"><p>Each class implements a series of <em>methods</em>, where each method performs
one task and is implemented as a C function.</p></div>
<h3 id="language-1">Language</h3>
<div class="paragraph"><p>The language for all names and comments SHALL be English.</p></div>
<h3 id="naming">Naming</h3>
<div class="paragraph"><p>Names SHOULD be chosen for ease of readability, and consistency. Unless
otherwise specified, the following style rules apply to all given names:</p></div>
<div class="ulist"><ul>
<li>
<p>
Names SHALL be short words that are simple, clear, and obvious to the
reader.
</p>
</li>
<li>
<p>
Names SHALL be used consistently for any given semantics.
</p>
</li>
<li>
<p>
Names SHOULD NOT be invented words or acronyms.
</p>
</li>
<li>
<p>
Names MAY be abbreviations if used widely.
</p>
</li>
<li>
<p>
Names SHALL NOT be reserved C or C++ keywords.
</p>
</li>
</ul></div>
<h2 id="project-style">Project Style</h2>
<h3 id="project-focus">Project Focus</h3>
<div class="paragraph"><p>The project SHALL focus on one identifiable problem space, which SHALL
be stated explicitly in the project <code>README</code>.</p></div>
<h3 id="project-name">Project Name</h3>
<div class="paragraph"><p>The project SHALL have these short names and abbreviations:</p></div>
<div class="ulist"><ul>
<li>
<p>
A <em>project short name</em> used in paths and URLs that identify the
project. This would be used for instance in the GitHub project name.
In this Specification we will use <code>myproject</code> as the example.
</p>
</li>
<li>
<p>
A <em>project prefix</em> used for project files, output libraries, and
method names. This would be used for instance in the library produced
for the project. The prefix MAY be an acronym. In this Specification we
will use <code>myp</code> as the example.
</p>
</li>
</ul></div>
<div class="paragraph"><p>These names SHALL be noted in the project <code>README</code>.</p></div>
<h3 id="general-layout">General Layout</h3>
<div class="paragraph"><p>The project SHALL contain at least these files and directories:</p></div>
<div class="ulist"><ul>
<li>
<p>
A <code>README</code> file that refers to this Specification and provides other
necessary information about the project.
</p>
</li>
<li>
<p>
A license file (e.g., <code>COPYING</code> or <code>LICENSE</code>) that specifies the terms
of distribution for the project.
</p>
</li>
<li>
<p>
An <code>include</code> directory for all header files.
</p>
</li>
<li>
<p>
A <code>src</code> directory for all library source files.
</p>
</li>
<li>
<p>
The <em>public header file</em> (<code>include/myproject.h</code>).
</p>
</li>
<li>
<p>
Scripts and makefiles to build and test the project on at least one
platform.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The project MAY contain these files and directories which MUST have
these names if present at all:</p></div>
<div class="ulist"><ul>
<li>
<p>
An <code>AUTHORS</code> file listing all contributors to the project.
</p>
</li>
<li>
<p>
A <code>doc</code> directory containing documentation.
</p>
</li>
<li>
<p>
The <em>internal header file</em> (<code>src/myp_classes.h</code>).
</p>
</li>
</ul></div>
<div class="paragraph"><p>The project SHOULD install these files:</p></div>
<div class="ulist"><ul>
<li>
<p>
The project header files and all class header files that form part of
the public API.
</p>
</li>
<li>
<p>
The project library, named with the project prefix (<code>libmyp.a</code> and/or
<code>libmyp.so(.*)</code> on POSIX platforms and <code>libmyp.pc</code> declarations for the
<code>pkg-config</code>, and <code>myp.dll</code> on Windows).
</p>
</li>
<li>
<p>
Command-line tools, if present.
</p>
</li>
<li>
<p>
Distribution-dependent service files for programs intended to run as
daemons (e.g. classic init-scripts, systemd units, Solaris SMF manifests).
</p>
</li>
</ul></div>
<h3 id="dependencies">Dependencies</h3>
<div class="paragraph"><p>The project SHALL depend at least on CZMQ (<code>libczmq</code>), which imports
ZeroMQ (<code>libzmq</code>), to provide portable APIs around networking, threads,
file systems, and other aspects.</p></div>
<div class="paragraph"><p>The project SHALL depend at least on <code>asciidoc</code> to render end-user formats
of documentation. It MAY depend on use of <code>xmlto</code>, <code>docbook</code>, <code>fo</code>, <code>a2x</code>,
<code>ghostscript</code> and other common backends and tools for rendering of specific
final formats. The project SHALL NOT depend on tools not available freely
to anybody as required part of its documentation processing recipes (e.g.
as a component of the <code>make distcheck</code> recipe chain).</p></div>
<h3 id="project-header-files">Project Header Files</h3>
<div class="paragraph"><p>The project SHALL provide two services via header files:</p></div>
<ol>
<li>
A set of internal definitions to class source files, which a class
source file can access with a single <code>#include</code> statement.
</li>
<li>
A public API that calling applications can access with a single
<code>include</code> statement.
</li>
</ol>
<div class="paragraph"><p>These two services MAY be combined into one project header file
(<code>myproject.h</code>), or MAY be split into an public header file
(<code>include/myproject.h</code>) and an internal header file (<code>src/myp_classes.h</code>).
The project MAY further break down these header files if necessary.</p></div>
<div class="paragraph"><p>The public header file SHALL define a version number for the project as
follows:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>//  MYPROJECT version macros for compile-time API detection
#define MYPROJECT_VERSION_MAJOR 1
#define MYPROJECT_VERSION_MINOR 0
#define MYPROJECT_VERSION_PATCH 0

#define MYPROJECT_MAKE_VERSION(major, minor, patch) \
    ((major) * 10000 + (minor) * 100 + (patch))
#define MYPROJECT_VERSION \
    MYPROJECT_MAKE_VERSION(MYPROJECT_VERSION_MAJOR, \
                           MYPROJECT_VERSION_MINOR, \
                           MYPROJECT_VERSION_PATCH)</pre>
</div></div>
<div class="paragraph"><p>The project header file SHALL assert the required version numbers for
any dependencies immediately after including their respective header
files, like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>#include &lt;czmq.h&gt;
#if CZMQ_VERSION &lt; 10203
1. error "myproject needs CZMQ/1.2.3 or later"
#endif</pre>
</div></div>
<div class="paragraph"><p>Definitions in the public header file are visible to calling
applications as well as class source code. The public header file SHALL
<code>#include</code> all class header files that form part of the public API for the
project.</p></div>
<div class="paragraph"><p>Definitions in the internal header file are visible only to class source
code. The internal header file, if present, SHALL include the public
header file, all class header files, and all system and library header
files needed by the project. The primary goal here is to keep delicate
system-dependent <code>#include</code> chains in a single place, and away from class
source code.</p></div>
<h3 id="template-readme-file">Template README File</h3>
<div class="admonition note">
<div class="icon">
<img src="images/icons//note.png" alt="Note">
</div>
<div class="content">A copy of the sample below is committed into the repository as
<code>README-CLASS-template.asciidoc</code>.</div>
</div>
<div class="listingblock">
<div class="content monospaced">
<pre>Project Title
=============
Maintainter Name &lt;user@domain.org&gt;

== Project Title

&lt;One-paragraph statement of the goals of the project, and the problems
it aims to solve&gt;.

== References

* Contribution policy is defined by C4 (http://rfc.zeromq.org/spec:42).
* Project style guide is defined by CLASS (http://rfc.zeromq.org/spec:21).
** short name: &lt;shortname&gt;
** prefix: &lt;prefix&gt;
* Licensed under &lt;license name&gt;, see COPYING
* Language level: C99</pre>
</div></div>
<div class="admonition note">
<div class="icon">
<img src="images/icons//note.png" alt="Note">
</div>
<div class="content">Update links to C4 and CLASS version adhered to by the project.</div>
</div>
<h3 id="language-level">Language Level</h3>
<div class="paragraph"><p>The project SHOULD use the C99 language for best clarity, but MAY use
the C89 language for compatibility with older platforms. The language
level SHALL be noted in the project README and all source code SHALL
conform to it.</p></div>
<div class="admonition note">
<div class="icon">
<img src="images/icons//note.png" alt="Note">
</div>
<div class="content">Microsoft Visual C/C++ does <em>not</em> support C99 and projects must
build using C++ language extensions to get access to C99 syntax. Because
of this, projects SHOULD NOT use any C99 syntax that is not a strict
subset of C++.</div>
</div>
<h3 id="use-of-the-preprocessor">Use of the Preprocessor</h3>
<div class="paragraph"><p>Project source code SHOULD NOT include any header files except the
project header file. This ensures that all class source code compiles in
exactly the same environment.</p></div>
<div class="paragraph"><p>Project source code SHALL NOT define "magic numbers" (numeric
constants); these SHALL be defined in the external or internal header
file, as appropriate.</p></div>
<div class="paragraph"><p>Projects MAY use the preprocessor for these purposes:</p></div>
<div class="ulist"><ul>
<li>
<p>
To create backwards compatibility with older code.
</p>
</li>
<li>
<p>
To improve portability by e.g., mapping non-portable system calls into
more portable ones.
</p>
</li>
<li>
<p>
To create precise, small macros with high usability.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Projects SHOULD NOT use the preprocessor for other work except when it
significantly reduces the complexity of code.</p></div>
<div class="paragraph"><p>Macro names SHALL be uppercase when they represent constants, and
lowercase when they act as functions.</p></div>
<h2 id="class-styles">Class Styles</h2>
<h3 id="file-organization">File Organization</h3>
<div class="paragraph"><p>Each class SHALL be written as two files:</p></div>
<div class="ulist"><ul>
<li>
<p>
A header file: <code>include/myp_myclass.h</code>
</p>
</li>
<li>
<p>
A source file: <code>src/myp_myclass.c</code>
</p>
</li>
</ul></div>
<div class="paragraph"><p>These two files SHALL be the original documentation for the class.
Specifically, the class header SHALL define the API for the class, and
the class source file SHALL define the implementation of each method.</p></div>
<div class="paragraph"><p>Class names SHALL follow the General Style for Naming. We will use
<code>myclass</code> in examples.</p></div>
<div class="paragraph"><p>Every source and header file SHALL start with an appropriate file header
that states at least:</p></div>
<div class="ulist"><ul>
<li>
<p>
The name of the class or file and its purpose
</p>
</li>
<li>
<p>
The copyright statement for the class
</p>
</li>
<li>
<p>
The name of the project and a URL if relevant
</p>
</li>
<li>
<p>
The summary license statement
</p>
</li>
</ul></div>
<div class="paragraph"><p>Here is a template file header for an MPLv2 open source project:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>/*  =========================================================================
    &lt;name&gt; - &lt;description&gt;

    Copyright (c) the Contributors as noted in the AUTHORS file.
    This file is part of MYPROJ, see https://github.com/MYORG/MYPROJ.

    This Source Code Form is subject to the terms of the Mozilla Public
    License, v. 2.0. If a copy of the MPL was not distributed with this
    file, You can obtain one at http://mozilla.org/MPL/2.0/.
    =========================================================================
*/</pre>
</div></div>
<h3 id="class-types">Class Types</h3>
<div class="paragraph"><p>We define two types of class:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>Stateful classes</em>, where the class provides methods working on
<em>instances</em>, which are like "objects" in an object-oriented language.
</p>
</li>
<li>
<p>
<em>Stateless classes</em>, where the class provides methods that work purely
on data provided by the caller or system.
</p>
</li>
</ul></div>
<div class="paragraph"><p>A stateful class SHALL provide these methods:</p></div>
<div class="ulist"><ul>
<li>
<p>
A constructor method <code>myp_myclass_new ()</code>
</p>
</li>
<li>
<p>
A destructor method <code>myp_myclass_destroy ()</code>
</p>
</li>
<li>
<p>
A self-test method <code>myp_myclass_test ()</code>
</p>
</li>
</ul></div>
<div class="paragraph"><p>A stateful class MAY provide these methods, and SHALL use these names
when providing such functionality:</p></div>
<div class="ulist"><ul>
<li>
<p>
A duplicator method <code>myp_myclass_dup ()</code>
</p>
</li>
<li>
<p>
A set of list navigation methods <code>myp_myclass_first ()</code> and
<code>myp_myclass_next ()</code>.
</p>
</li>
<li>
<p>
Print methods <code>myp_myclass_print ()</code> and <code>myp_myclass_fprint ()</code>.
</p>
</li>
</ul></div>
<div class="paragraph"><p>A stateless class SHALL provide at least this method:</p></div>
<div class="ulist"><ul>
<li>
<p>
A self-test method <code>myp_myclass_test ()</code>.
</p>
</li>
</ul></div>
<h3 id="method-names">Method Names</h3>
<div class="paragraph"><p>Method names SHALL follow the General Style for Naming. Method names
SHOULD be verbs ("destroy", "insert", "lookup") or adjectives ("ready",
"empty", "new"). The method name SHOULD imply the method return type,
where verbs return a success/failure indicator, if anything, and
adjectives return a value or instance.</p></div>
<h3 id="class-header-file">Class Header File</h3>
<div class="paragraph"><p>The class header file SHALL have this layout:</p></div>
<div class="ulist"><ul>
<li>
<p>
The file header
</p>
</li>
<li>
<p>
An outer <code>#ifndef</code> that makes it safe to include the header file
multiple times
</p>
</li>
<li>
<p>
Calling conventions for C++
</p>
</li>
<li>
<p>
A forward reference to the class type, for stateful classes
</p>
</li>
<li>
<p>
Prototypes for the class methods
</p>
</li>
</ul></div>
<div class="paragraph"><p>Here is a template header file for stateful classes, not showing the
file header:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>#ifndef __MYMOD_H_INCLUDED__
#define __MYMOD_H_INCLUDED__

#ifdef __cplusplus
extern "C" {
#endif

//  Opaque class structure
typedef struct _myp_myclass_t myp_myclass_t;

//  Create a new &lt;class name&gt; instance
CZMQ_EXPORT myp_myclass_t *
    myp_myclass_new (void);

//  Destroy a &lt;class name&gt; instance
CZMQ_EXPORT void
    myp_myclass_destroy (myp_myclass_t **self_p);

//  Self test of this class
void
    myp_myclass_test (bool verbose);

#ifdef __cplusplus
}
#endif

#endif</pre>
</div></div>
<div class="paragraph"><p>Here is a similar template header file for stateless classes:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>#ifndef __MYMOD_H_INCLUDED__
#define __MYMOD_H_INCLUDED__

#ifdef __cplusplus
extern "C" {
#endif

//  Self test of this class
int
    myp_myclass_test (bool verbose);

#ifdef __cplusplus
}
#endif

#endif</pre>
</div></div>
<div class="paragraph"><p>All public methods SHALL be declared with <code>CZMQ_EXPORT</code> in the class
header file so that these methods are properly exported on operating
systems that require it.</p></div>
<h3 id="class-source-file">Class Source File</h3>
<div class="paragraph"><p>The class source file SHALL define:</p></div>
<div class="ulist"><ul>
<li>
<p>
The class structure, for stateful classes. This structure SHALL be
<em>opaque</em> and known only to code in the class source file.
</p>
</li>
<li>
<p>
The class methods, in the same order as defined in the class header:
constructor, destructor, other methods, and finally self test.
</p>
</li>
<li>
<p>
Any static functions used in the class methods.
</p>
</li>
<li>
<p>
Any global or static variables needed.
</p>
</li>
</ul></div>
<h3 id="class-properties">Class Properties</h3>
<div class="paragraph"><p>For stateful classes, the class structure has one or more properties
defined as a private C structure in the class source file.</p></div>
<div class="paragraph"><p>This SHOULD be defined as follows:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>//  Structure of our class

struct _myclass_t {
    &lt;type&gt; &lt;name&gt;;              //  &lt;description&gt;
};</pre>
</div></div>
<div class="paragraph"><p>Property names SHALL follow the General Style for Naming. Property names
SHOULD be nouns or adjectives (typically used for Boolean properties).
We will use <code>myprop</code> in examples.</p></div>
<h2 id="method-styles">Method Styles</h2>
<h3 id="general-rules">General Rules</h3>
<h4>Argument Names</h4>
<div class="paragraph"><p>Argument names SHALL be consistent with property names.</p></div>
<h4>Return Values</h4>
<div class="paragraph"><p>Success/failure SHALL be indicated by returning an <code>int</code>, with values
<code>0</code> or <code>-1</code> respectively.</p></div>
<div class="paragraph"><p>Strings SHALL be returned as <code>char *</code> when they are passed to the
caller, who must free them.</p></div>
<div class="paragraph"><p>Strings SHALL be returned as <code>const char *</code> when the caller may not
modify or free them.</p></div>
<div class="paragraph"><p>Compound return values, e.g. a size-specified buffer, SHOULD be returned
as fresh objects of a suitable class. The API SHOULD NOT return compound
values via multiple routes, e.g. data via an argument and size via the
return code.</p></div>
<h3 id="the-self-test-method">The Self Test Method</h3>
<div class="paragraph"><p>In stateless classes, the only standard method is <code>myp_myclass_test ()</code>,
which SHALL conduct a self test of the class, returning silently on
success, and asserting on failure.</p></div>
<div class="paragraph"><p>The self test method shall take this general form:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>//  --------------------------------------------------------------------------
//  Runs selftest of class

void
myp_myclass_test (int verbose)
{
    printf (" * myp_myclass: ");
    //  Conduct tests of every method
    printf ("OK\n");
}</pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
The self test method SHALL be a primary source of example code for
users of the class.
</p>
</li>
<li>
<p>
The self test method SHOULD cover every other method in the class.
</p>
</li>
</ul></div>
<h3 id="stateful-classes">Stateful Classes</h3>
<h4>The Constructor Method</h4>
<div class="paragraph"><p>The constructor SHALL take this general form:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>//  Create a new myp_myclass instance
myp_myclass_t *
myp_myclass_new (&lt;arguments&gt;)
{
    myp_myclass_t *self = (myp_myclass_t *) zmalloc (sizeof (myp_myclass_t));
    assert (self);
    self-&gt;someprop = someprop_new ();
    assert (self-&gt;someprop);
    return self;
}</pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
The constructor SHALL initialize all properties in new class
instances. Properties SHALL either get a suitable initial value, or be
set to zero. Very large properties MAY exceptionally be left
uninitialized for performance reasons; such behavior MUST be explicitly
noted in the constructor body.
</p>
</li>
<li>
<p>
Any properties that are dynamically allocated SHOULD be allocated in
the constructor but MAY be left as null.
</p>
</li>
<li>
<p>
The constructor MAY take one or more arguments, which SHALL correspond
to properties to be initialized.
</p>
</li>
<li>
<p>
The constructor SHALL return either a new instance reference, or null,
if construction failed.
</p>
</li>
</ul></div>
<h4>The Destructor Method</h4>
<div class="paragraph"><p>The destructor SHALL take this general form:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>//  Destroy a myp_myclass instance
void
myp_myclass_destroy (myp_myclass_t **self_p)
{
    assert (self_p);
    if (*self_p) {
        myp_myclass_t *self = *self_p;
        someprop_destroy (&amp;self-&gt;someprop);
        anotherprop_destroy (&amp;self-&gt;anotherprop);
        lastprop_destroy (&amp;self-&gt;lastprop);
        free (self);
        *self_p = NULL;
    }
}</pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
The destructor SHALL <code>null</code>-ify the provided instance reference.
</p>
</li>
<li>
<p>
The destructor SHALL be idempotent, i.e. it can be called safely on the
same instance reference more than once.
</p>
</li>
<li>
<p>
The destructor SHALL safely free properties and child class instances
that are not <code>null</code>.
</p>
</li>
</ul></div>
<h4>The Duplicator Method</h4>
<div class="paragraph"><p>The class MAY offer a duplicator method which creates a full copy of an
instance; if it offers such semantics, the method MUST be called
<code>myp_myclass_dup ()</code> and take this general form:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>//  Create a copy of a myp_myclass instance

myp_myclass_t *
myp_myclass_dup (myp_myclass_t *self)
{
    if (self) {
        assert (self);
        myp_myclass_t *copy = myp_myclass_new (...);
        if (copy) {
            //  Initialize copy
        }
        return copy;
    }
    else
        return NULL;
}</pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
The duplicator SHALL return either a new instance reference, or <code>null</code>
if construction failed, in the same manner as the constructor.
</p>
</li>
<li>
<p>
The duplicator SHALL accept a <code>null</code> instance reference, and then return
<code>null</code>.
</p>
</li>
<li>
<p>
A duplicated instance SHALL be entirely independent of the original
instance (i.e. all properties SHALL also be duplicated).
</p>
</li>
</ul></div>
<h4>List Navigation Methods</h4>
<div class="paragraph"><p>A class MAY act as a list container for other items, which may be child
class instances, strings, memory blocks, or other structures.</p></div>
<div class="paragraph"><p>Such a container class SHALL keep the list cursor position in the
instance, and provide the following methods for navigating the list:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>//  Return first item in the list or null if the list is empty

item_t *
myp_myclass_first (myp_myclass_t *self)
{
    assert (self);
    //  Reset cursor to first item in list
    return item;
}

//  Return next item in the list or null if there are no more items

item_t *
myp_myclass_next (myp_myclass_t *self)
{
    assert (self);
    //  Move cursor to next item in list
    return item;
}</pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
The navigation methods SHALL return <code>null</code> to indicate "no more items".
</p>
</li>
<li>
<p>
The navigation methods SHALL be idempotent, and specifically, calling
<code>myp_myclass_next ()</code> when at the end of the list SHALL return null each
time.
</p>
</li>
<li>
<p>
The class MAY offer <code>myp_myclass_last ()</code> and <code>myp_myclass_prev ()</code>
methods.
</p>
</li>
<li>
<p>
The class MAY offer <code>myp_myclass_size ()</code> which returns the list size.
</p>
</li>
<li>
<p>
If the class offers methods to create list items, these SHALL be
called <code>myp_myclass_append ()</code> (to add to the end of the list) and
<code>myp_myclass_insert ()</code> (to add to the start of the list).
</p>
</li>
<li>
<p>
If the class offers a method to remove a list item, this SHALL be
called <code>myp_myclass_delete ()</code>; it SHALL take the item reference as
argument, and it SHALL delete the first matching item in the list, if
any.
</p>
</li>
<li>
<p>
If the class maintains multiple lists, it SHALL create unique method
names for each list by adding a list name, e.g.,
<code>myp_myclass_myitem_first ()</code>.
</p>
</li>
</ul></div>
<h4>Accessor Methods</h4>
<div class="paragraph"><p>The class MAY expose instance properties via its API, in which case this
SHALL be done through accessor methods.</p></div>
<div class="paragraph"><p>To return the value of a property the class SHALL define an accessor
method like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>//  Return the value of myprop
&lt;type&gt;
myp_myclass_myprop (myp_myclass_t *self)
{
    assert (self);
    return self-&gt;myprop;
}</pre>
</div></div>
<div class="paragraph"><p>To write the value of a property, if this is permitted, the class SHALL
define an accessor method like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>//  Set the value of myprop
void
myp_myclass_set_myprop (myp_myclass_t *self, &lt;type&gt; myprop)
{
    assert (self);
    self-&gt;myprop = myprop;
}</pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
Properties exposed by accessor methods MAY not actually exist as such
in the instance; they may be calculated rather than simply copied
to/from the instance structure.
</p>
</li>
</ul></div>
<h4>Formatted String Arguments</h4>
<div class="paragraph"><p>When a method (such as an accessor method) accepts a string argument as
primary argument, it SHOULD use a variable argument list and perform
<code>vsnprintf</code> formatting on that string argument.</p></div>
<h4>General Methods</h4>
<div class="paragraph"><p>The class MAY offer any number of other methods that operate on the
instance. These methods shall take this general form:</p></div>
<div class="ulist"><ul>
<li>
<p>
The first argument to the method SHALL be the instance reference.
</p>
</li>
<li>
<p>
Other arguments may follow.
</p>
</li>
</ul></div>
<div class="paragraph"><p>A method may take ownership of an object instance and then act as a
destructor of the object instance at some later stage. In that case the
method SHALL use the same style as the destructor.</p></div>
<h4>Return Values</h4>
<div class="paragraph"><p>Methods SHOULD use one of the following patterns for returning values to
the caller:</p></div>
<div class="ulist"><ul>
<li>
<p>
Returning nothing, if no return value is expected.
</p>
</li>
<li>
<p>
Returning a property value, on an accessor method.
</p>
</li>
<li>
<p>
Returning an object instance, on a constructor or duplicator.
</p>
</li>
<li>
<p>
Returning a child value, on a list navigation method.
</p>
</li>
<li>
<p>
Returning zero on success, -1 on failure.
</p>
</li>
<li>
<p>
Returning a freshly-allocated string.
</p>
</li>
</ul></div>
<h2 id="code-style">Code Style</h2>
<h3 id="thread-safety">Thread Safety</h3>
<div class="ulist"><ul>
<li>
<p>
All methods SHALL be thread safe.
</p>
</li>
<li>
<p>
Class instances SHOULD NOT generally be thread safe; a class instance
will be owned by a single calling thread.
</p>
</li>
<li>
<p>
In exceptional cases class instances MAY be made thread safe by the
addition of mutexes or locks inside methods.
</p>
</li>
</ul></div>
<h3 id="heap-use">Heap Use</h3>
<div class="paragraph"><p>One of the goals of CLASS is to hide heap use as far as possible within
classes. Application programs SHOULD use the heap only through
constructors and duplicators (including the library <code>strdup ()</code> function).
Class methods MAY use the heap with care, but follow these rules:</p></div>
<div class="ulist"><ul>
<li>
<p>
When a class instance has been destroyed, all heap memory it used MUST
be freed. Classes SHALL NOT leak memory under any conditions except
during abnormal termination (e.g., on a failed assertion).
</p>
</li>
<li>
<p>
Non-atomic properties SHOULD be re-allocated (i.e., freed and
allocated) in accessor functions that modify them, as needed.
</p>
</li>
<li>
<p>
The instance structure MAY use <code>char[]</code> arrays instead of heap allocated
<code>char*</code> pointers.
</p>
</li>
<li>
<p>
When freeing a non-atomic property outside the destructor, a method
MUST set the property to <code>null</code> if it does not allocate a new value
immediately.
</p>
</li>
</ul></div>
<h3 id="static-variables">Static Variables</h3>
<div class="paragraph"><p>Classes SHOULD NOT use static variables except in exceptional cases,
such as for global variables.</p></div>
<div class="paragraph"><p>Static variables are not thread safe and they are therefore considered
poor practice.</p></div>
<div class="paragraph"><p>Particularly for representing any temporary state inside a class body,
stack variables SHALL be used in place of static variables.</p></div>
<h3 id="static-functions">Static Functions</h3>
<div class="paragraph"><p>Functions that are not exported by a class are defined as <code>static</code> and
named <code>s_functionname ()</code> with no use of the project prefix or class name.</p></div>
<div class="paragraph"><p>Static functions MAY be defined before first use, or MAY be prototyped
and defined immediately after first use.</p></div>
<div class="paragraph"><p>Static functions SHOULD NOT be collected at the end of the class source
code.</p></div>
<h2 id="code-style-1">Code Style</h2>
<h3 id="indentation">Indentation</h3>
<div class="paragraph"><p>Indentation SHALL be 4 spaces per level. Tab characters SHALL NOT be
used in code.</p></div>
<h3 id="declarations">Declarations</h3>
<div class="paragraph"><p>Functions SHALL be prototyped as follows:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>&lt;type&gt;
    &lt;name&gt; (&lt;arguments&gt;);</pre>
</div></div>
<div class="paragraph"><p>Functions SHALL be defined as follows:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>&lt;type&gt;
&lt;name&gt; (&lt;arguments&gt;)
{
    &lt;body&gt;
}</pre>
</div></div>
<div class="paragraph"><p>When the project uses C99, stack variables SHALL be defined in-line, as
close as possible to their first use, and initialized. For example:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>myp_myclass_t *myclass = myp_myclass_new ();
char *comma = strchr (surname, '.');</pre>
</div></div>
<div class="paragraph"><p>When the project uses C89, stack variables SHALL all be defined and
initialized at the start of the function or method where they are used.</p></div>
<div class="ulist"><ul>
<li>
<p>
Variables and functions SHALL use lower-case names.
</p>
</li>
<li>
<p>
Where necessary, underlines SHALL be used to separate parts of a name.
</p>
</li>
<li>
<p>
Variable names like <code>i</code> and <code>temp</code> that carry no information SHALL NOT be
used.
</p>
</li>
</ul></div>
<h3 id="statements">Statements</h3>
<div class="paragraph"><p>Code lines of more than 80-100 characters SHOULD be folded for
readability.</p></div>
<div class="paragraph"><p>Single-statement blocks SHALL NOT be enclosed in brackets.</p></div>
<div class="paragraph"><p>This is the form of a single-statement block:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>if (comma == NULL)
    comma = surname;</pre>
</div></div>
<div class="paragraph"><p>In <code>else</code> statements, the <code>else</code> SHALL be put on a line by itself.</p></div>
<div class="paragraph"><p>Multiple <code>if</code>/<code>else</code> tests SHALL be stacked vertically to indicate that
the order is arbitrary.</p></div>
<div class="paragraph"><p>This is the form of a stacked <code>if</code> statement block:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>if (command == CMD_HELLO)
    puts ("hello");
else
if (command == CMD_GOODBYE)
    puts ("goodbye");
else
if (command == CMD_ERROR)
    puts ("error");</pre>
</div></div>
<div class="paragraph"><p>With multi-statement conditional blocks, the closing bracket SHALL be
put on a line by itself, aligned with the opening keyword.</p></div>
<div class="paragraph"><p>This is the form of a stacked <code>if</code> statement block with brackets around
each conditional block:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>if (command == CMD_HELLO) {
    puts ("hello");
    myp_peer_reply (peer, CMD_GOODBYE);
}
else
if (command == CMD_GOODBYE) {
    puts ("goodbye");
    myp_peer_reply (peer, CMD_DISCONNECT);
}
else
if (command == CMD_ERROR) {
    puts ("error");
    myp_peer_close (peer);
}</pre>
</div></div>
<div class="paragraph"><p>This is the form of a <code>while</code> statement:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>char *comma = strchr (surname, ',');
while (comma) {
    *comma = ' ';
    comma = strchr (surname, ',');
}</pre>
</div></div>
<h3 id="comments">Comments</h3>
<div class="paragraph"><p>Comments on code SHALL be used lightly and where necessary.</p></div>
<div class="paragraph"><p>In C99 projects the syntax for comments is:</p></div>
<div class="ulist"><ul>
<li>
<p>
In-line comments SHALL use the C++ <code>//</code> style.
</p>
</li>
<li>
<p>
Multi-line comments MAY use the C <code>/* ... */</code> style or MAY use the C++
<code>//</code> style.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In C89 projects the syntax for all comments SHALL be the C <code>/* ... */</code>
style.</p></div>
<div class="ulist"><ul>
<li>
<p>
When possible in-line comments shall start at column 33.
</p>
</li>
<li>
<p>
In in-line comments, the <code>//</code> or <code>/*</code> shall be followed by two spaces.
</p>
</li>
<li>
<p>
Every function shall have a multi-line comment header that briefly
explains its purpose.
</p>
</li>
<li>
<p>
Method comment headers SHALL be preceded by a line of hyphens ending
at column 78.
</p>
</li>
<li>
<p>
Suitably-marked-up comments before a function MAY be used as source
material for reference documentation.
</p>
</li>
</ul></div>
<div class="paragraph"><p>This is the general template for a method comment header:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>//  --------------------------------------------------------------------------
//  Finds the first item in the list, returns null if the list is empty.

myp_myclass_t *
myp_myclass_first (myp_myclass_t *self)
{
    ...</pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
Every property in a class structure SHALL have a 1-line in-line
comment that describes its purpose.
</p>
</li>
<li>
<p>
Comments SHALL NOT be used to compensate for illegible code.
</p>
</li>
<li>
<p>
Code that cannot be reasonably read and understood by the casual
reader SHOULD be rewritten, not annotated.
</p>
</li>
<li>
<p>
Properties and functions whose semantics are not clear from their
names SHOULD be renamed, not annotated.
</p>
</li>
</ul></div>
<h3 id="blank-lines">Blank Lines</h3>
<div class="paragraph"><p>Blank lines SHALL be used to separate blocks of code to improve
readability, in these cases:</p></div>
<div class="ulist"><ul>
<li>
<p>
After the closing bracket of a function body and before the comment
header for a function.
</p>
</li>
<li>
<p>
To break up blocks of code that exceed 6-8 lines.
</p>
</li>
<li>
<p>
After assertions at the start of a class body.
</p>
</li>
<li>
<p>
After an <code>if</code> statement with a single-statement block.
</p>
</li>
<li>
<p>
After multi-line <code>case</code> blocks inside a <code>switch</code> statement.
</p>
</li>
<li>
<p>
After multi-line comment blocks.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Blank lines SHALL NOT be used in these cases:</p></div>
<div class="ulist"><ul>
<li>
<p>
After the closing bracket of a conditional block.
</p>
</li>
<li>
<p>
To separate individual lines of code that could better be grouped
together.
</p>
</li>
</ul></div>
<h3 id="vertical-alignment">Vertical Alignment</h3>
<div class="paragraph"><p>Code SHALL NOT use extra spacing to create vertical alignment.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>char *comma = strchr (surname, ',');
while (comma) {
    *comma = ' ';
    comma = strchr (surname, ',');
}</pre>
</div></div>
<h3 id="punctuation">Punctuation</h3>
<div class="paragraph"><p>Punctuation SHALL follow English rules as far as possible.</p></div>
<div class="paragraph"><p>This is the style for unary operators, with a space after but not before
the operator:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>char_nbr++;</pre>
</div></div>
<div class="paragraph"><p>This is the style for binary operators, with a space before and after
the operator:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>comma = comma + 1;</pre>
</div></div>
<div class="paragraph"><p>This is the style for the ?: operator:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>comma = comma? comma + 1: strchr (name, '.');</pre>
</div></div>
<div class="paragraph"><p>This is the style for semi-colons, with a space after but not before:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>for (char_nbr = 0; *char_nbr; char_nbr++)
    char_nbr++;</pre>
</div></div>
<div class="paragraph"><p>This is the style for parentheses, with a space before the opening, and
after the closing parenthesis, with multiple opening or closing
parentheses joined together without spaces:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>node = (node_t *) zmalloc (sizeof (node_t));
if (!node)
    return -1;</pre>
</div></div>
<div class="paragraph"><p>This is the style for square brackets:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>comma = name [char_nbr];</pre>
</div></div>
<div class="paragraph"><p>This is the style for pointer dereferences, with no space before or
after the <code>-&gt;</code>:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>self-&gt;name = strdup (name);</pre>
</div></div>
<h3 id="assertions">Assertions</h3>
<div class="paragraph"><p>Classes SHOULD check the validity of arguments using assertions. That
is, misuse of the API is considered a programming error, not a run-time
error.</p></div>
<div class="ulist"><ul>
<li>
<p>
Assertions SHALL be used for their documentary value, for example to
warn the reader, "this argument SHALL NOT be null".
</p>
</li>
<li>
<p>
Assertions on arguments SHALL come at the start of the class body and
SHALL follow the order of the arguments.
</p>
</li>
<li>
<p>
Assertions MAY be used on return values from function calls if such
failures cannot safely be handled by the code.
</p>
</li>
<li>
<p>
Assertions MAY be used on internal state (e.g., instance properties)
to assert a mandatory condition for continuing.
</p>
</li>
<li>
<p>
Assertions SHALL NOT be used to trap errors on external conditions,
e.g., bad user input, invalid protocol messages, etc.
</p>
</li>
<li>
<p>
Assertions SHOULD be used to trap errors on internal APIs, e.g.
invalid messages sent from one thread to another.
</p>
</li>
<li>
<p>
Assertions SHALL NOT have side-effects since the entire statement may
be removed by an optimizing compiler.
</p>
</li>
</ul></div>
<h3 id="exiting-functions-and-goto-statements">Exiting Functions and Goto Statements</h3>
<div class="paragraph"><p>The <code>return</code> statement MAY be used at any point in a function to return
to the caller.</p></div>
<div class="paragraph"><p>If the function needs to do clean-up (e.g. to free a number of
properties), the code MAY use <code>goto</code> and a single clean-up block at the
end of the function. Such a clean-up block SHALL follow the last
"normal" <code>return</code>.</p></div>
<div class="paragraph"><p>A <code>void</code> function SHALL NOT end in an empty <code>return</code> statement.</p></div>
<h3 id="recommended-patterns">Recommended Patterns</h3>
<div class="ulist"><ul>
<li>
<p>
The recommended pattern for an open-ended loop is <code>while (true) {}</code>,
with <code>break</code> statements as needed to exit the loop.
</p>
</li>
<li>
<p>
The recommended pattern for array iteration is:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content monospaced">
<pre>for (array_index = 0; array_index &lt; array_size; array_index++) {
    //  Access element [array_index]
}</pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
The recommended pattern for list iteration is:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content monospaced">
<pre>myp_myclass_t *myclass = (myp_myclass_t *) myp_myclass_first (myclass);
while (myclass) {
    //  Do something
    myclass = (myp_myclass_t *) myp_myclass_next (myclass);
}</pre>
</div></div>
<h2 id="portability">Portability</h2>
<h3 id="portable-versus-native-classes">Portable Versus Native Classes</h3>
<div class="paragraph"><p>All projects SHALL depend at least on ZeroMQ (<code>libzmq</code>) and CZMQ
(<code>libczmq</code>), which provide portable APIs around networking, threads, file
systems, and other aspects.</p></div>
<div class="ulist"><ul>
<li>
<p>
A class SHALL be either "portable" or "native".
</p>
</li>
<li>
<p>
A portable class SHALL NOT use the preprocessor to compile differently
on different systems.
</p>
</li>
<li>
<p>
A native class SHALL export a properly abstracted API that hides
system differences, and SHALL use the preprocessor to compile
differently on different systems.
</p>
</li>
<li>
<p>
A native class SHALL use the preprocessor macros defined in
<code>czmq_prelude.h</code>, and specifically the <strong><code>WINDOWS</code></strong>, <strong><code>UNIX</code></strong>, and
<code>__UTYPE_ABC</code> macros.
</p>
</li>
<li>
<p>
A native class SHALL NOT use preprocessor macros supplied by any
specific build system. If the CZMQ-supplied macros are not sufficient
these can be improved and extended.
</p>
</li>
<li>
<p>
The project architect SHOULD aim to fully separate portable and native
classes, so that application developers see and write only portable
classes.
</p>
</li>
</ul></div>
<div class="paragraph"><p>This example shows the general style of native code:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>#if (defined (__UNIX__))
    pid = GetCurrentProcessId ();
#elif (defined (__WINDOWS__))
    pid = getpid ();
#else
    pid = 0;
#endif</pre>
</div></div>
<h3 id="portable-language">Portable Language</h3>
<div class="paragraph"><p>The following types and macros are defined by CZMQ and may be used
safely in all code:</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>bool</code>, <code>true</code>, <code>false</code>: Boolean data type and constants.
</p>
</li>
<li>
<p>
<code>byte</code>, <code>dbyte</code>, <code>qbyte</code>: unsigned 1-, 2-, and 4-octet integers.
</p>
</li>
<li>
<p>
<code>uint</code>, <code>ulong</code>: unsigned integers and longs.
</p>
</li>
<li>
<p>
<code>int32_t</code>, <code>int64_t</code>: signed 32-bit and 64-bit integers.
</p>
</li>
<li>
<p>
<code>uint32_t</code>, <code>uint64_t</code>: unsigned 32-bit and 64-bit integers.
</p>
</li>
<li>
<p>
<code>streq (s1, s2)</code>: preferred over <code>strcmp (s1, s2) == 0</code>.
</p>
</li>
<li>
<p>
<code>strneq (s1, s2)</code>: preferred over <code>strcmp (s1, s2) != 0</code>.
</p>
</li>
<li>
<p>
<code>randof (number)</code>: return random integer in range <code>0</code> .. <code>number - 1</code>.
</p>
</li>
<li>
<p>
<code>srandom</code>: typically used like this: <code>srandom ((unsigned) time (NULL));</code>
</p>
</li>
<li>
<p>
<code>inline</code>, <code>snprintf</code>, <code>vsnprintf</code>: Windows uses non-POSIX variants with
underscores.
</p>
</li>
</ul></div>
<h3 id="compiler-warnings">Compiler Warnings</h3>
<div class="paragraph"><p>Compiler warnings SHOULD always be treated as fatal. The following is a
list of constructs known to cause warnings on some but not all
compilers:</p></div>
<div class="ulist"><ul>
<li>
<p>
Assigning a void pointer to a typed pointer without a cast. Always
cast a <code>void *</code> before assigning it to a typed pointer.
</p>
</li>
<li>
<p>
Failing to return a value in a non-void function. Always end a
non-void function with a <code>return</code> statement.
</p>
</li>
</ul></div>
<h2 id="code-generation">Code Generation</h2>
<div class="paragraph"><p>Code generation MAY be used to produce classes mechanically when there
is compelling benefit.</p></div>
<div class="ulist"><ul>
<li>
<p>
The code generator SHOULD be GSL, from <a href="https://github.com/imatix/gsl">https://github.com/imatix/gsl</a>.
</p>
</li>
<li>
<p>
All code generation scripts SHALL be in the project <code>src</code> subdirectory.
</p>
</li>
<li>
<p>
All model data (XML files) SHALL be in the project <code>src</code> directory.
</p>
</li>
<li>
<p>
If only parts of a class are generated, these parts SHALL have the
extension <code>.inc</code> and SHALL be generated into the project <code>src</code> directory,
and SHALL be included in the class source file using an <code>#include</code>
statement.
</p>
</li>
<li>
<p>
Code generation SHALL be done as a manual step. For example, <code>make
code</code>. All generated code SHALL be committed into the project as for
hand-written files.
</p>
</li>
<li>
<p>
Code generation SHALL be fully idempotent, that is, generated code
SHALL NOT contain any date or time stamps.
</p>
</li>
<li>
<p>
Code generation SHALL be treated as a form of dangerous abstraction
that creates significant barriers to readers. A good rule of thumb is
that for code generation to be profitable, it should reduce the lines of
code written by hand by 80-90%.
</p>
</li>
<li>
<p>
Generated code SHALL contain a warning of this form at the start:
<code>GENERATED SOURCE CODE, DO NOT EDIT</code>.
</p>
</li>
<li>
<p>
Generated code SHALL otherwise conform to this Specification so that
it is indistinguishable from hand-written code.
</p>
</li>
</ul></div>
<h2 id="security-aspects">Security Aspects</h2>
<h3 id="thread-safety-1">Thread Safety</h3>
<div class="paragraph"><p>The use of opaque data structures that are accessed via references is
thread safe. However:</p></div>
<div class="ulist"><ul>
<li>
<p>
Code SHALL NOT share state between threads except in exceptional and
limited cases. Threads SHALL communicate by passing 0MQ messages.
</p>
</li>
<li>
<p>
Classes SHALL not use static variables since this is not re-entrant,
thus not thread safe.
</p>
</li>
<li>
<p>
Class instances SHALL NOT be passed between threads except in
"hand-off" cases.
</p>
</li>
<li>
<p>
Code SHOULD NOT use mutexes, locks, or other mechanisms to share state
between threads.
</p>
</li>
<li>
<p>
Code MUST NOT use non-thread safe system calls such as <code>basename ()</code>.
</p>
</li>
</ul></div>
<h3 id="buffer-overflows">Buffer Overflows</h3>
<div class="ulist"><ul>
<li>
<p>
Code MUST always truncate over-long data.
</p>
</li>
<li>
<p>
Code MUST NOT use unsafe system calls such as <code>gets ()</code>.
</p>
</li>
</ul></div>
<h3 id="known-weaknesses">Known Weaknesses</h3>
<div class="ulist"><ul>
<li>
<p>
The heavy reliance on heap memory means that CLASS applications are
vulnerable to denial-of-service attacks. Applications can mitigate this
risk by enforcing limits on the number of class instances they create.
</p>
</li>
<li>
<p>
The heavy reliance on heap memory makes CLASS unsuitable for embedded
systems where all memory use must be static.
</p>
</li>
<li>
<p>
In most CLASS applications it is difficult to handle an "out of
memory" error in any way except to abort.
</p>
</li>
</ul></div>
</div>
        </div>  <!-- /.col-md-9 -->
        <div class="col-md-3">
        <div id="sidebar">
    <div class="toc2">
<div class="panel panel-default">
<div class="panel-heading">Table of Contents</div>
<div class="panel-body" id="toc">
</div>
</div>
    </div>
</div>
        </div>  <!-- /.col-md-3 -->
    </div>  <!-- /.row -->
    <script src="js/jquery.min.js"></script>
    <script src="js/42ity.js"></script>
    <script src="./js/bootstrap.min.js"></script>
    <script src="js/asciidoc.js"></script>
    <!-- Install TOC and/or footnotes (if necessary) -->
    <script type="text/javascript">asciidoc.install(3);</script>

    <!-- Remove footnotes if empty block -->
    <script type="text/javascript">$(function(){ if ($("#footnotes div").length == 0) $("#footnotes").parent().remove(); });</script>

    <script type="text/javascript">$(function(){ if ($("#dropdown-menu-versions")) $("#dropdown-menu-versions").parent().remove(); });</script>
    </div> <!-- page -->
  </body>
</html>
